# CLI アプリケーション実装計画 (改訂版)

このドキュメントでは、VS Code拡張機能をスタンドアロンのCLIアプリケーションとして実装するための計画を概説します。以前の計画を基に、ユーザーフィードバックを反映し、目的と必要な機能を明確にしました。

## 目的

現在のVS Code拡張機能は、GUI操作を前提としており、自動化が困難です。CLIアプリ化により、スクリプトからの自動操作を可能にし、以下のような機能を持つことを目指します。

- **非対話的なCLIインターフェース**: テキストコマンドによる指示入力、人間による入力を必要としない自動実行
- **AIによるコーディング支援**: CLIから受け取った指示に基づき、各種AIサービス (Anthropic, OpenAI等) へリクエストを行い、コード生成・編集等のコーディング作業を実行
- **差分出力**: コード変更内容を差分 (diff) 形式でCLIに出力し、人間によるレビューやフィードバックを容易化
- **ターミナル操作**: CLIアプリからターミナルコマンドを実行し、プロジェクトのビルド、テスト、実行などの操作をAIに実行させる

## 実装の概要

この拡張機能をCLIアプリケーションとして再構築するには、主に以下の手順が必要です。

1. **コアロジックの特定**: 現在のコードベースから、CLIアプリケーションの中核となる機能 (AIコーディング支援) を担う部分を特定します。これには以下が含まれると考えられます。
    - API連携ロジック (`src/api`)
    - コアアプリケーションロジック (`src/core`)
    - 共有ユーティリティ (`src/shared`, `src/utils`)
    - MCP連携 (`src/services/mcp`)
    - ターミナル連携 (`src/integrations/terminal`) - CLI環境に合わせて実装をNode.js標準モジュール等で代替

2. **VS Code依存性の分離**: 特定されたコアロジックからVS Code API (`vscode`モジュール) への依存性を徹底的に排除または置換します。CLIアプリケーションはVS Codeに依存しないスタンドアロンなものとして実装します。
    - **UI要素の置換**: Webview, 通知, 装飾, Diff ViewなどのVS Code UI要素を、CLIベースの同等の機能に置き換えます。
        - ユーザーとのインタラクション: コマンドライン引数、標準入力 (テキスト指示の受付)、標準出力 (テキスト出力、差分)
        - 差分表示: `diff`コマンドまたはNode.jsライブラリによる差分生成、CLIへのテキスト出力
    - **ファイルシステムアクセスの置換**: `vscode.workspace.fs` を Node.js の `fs` モジュールへ完全移行
    - **VS Code統合機能の削除**: 診断, テーマ, ワークスペース追跡, エディタ装飾など、CLIアプリケーションに不要なVS Code固有の機能は削除

3. **CLIエントリポイントの作成**: CLIアプリケーションのエントリーポイントとなる新しいファイル (`src/cli.ts` など) を作成します。
    - **コマンドライン引数解析**: `yargs` または `commander` などのライブラリを用いて、テキスト指示、API設定、出力形式などのCLI引数を解析
    - **コアロジック初期化**: VS Codeコンテキストに依存せず、CLI環境でコアアプリケーションロジックを初期化
    - **CLIベースの入出力**:  CLIプロンプトによるユーザー指示受付 (初期段階、必要に応じて削除),  標準出力へのテキストおよび差分出力
    - **CLI環境でのツール実行**:  CLI環境で `execute_command` などのツール実行、結果処理、ユーザーへのフィードバック (テキスト出力) を実装。ツール承認プロセスはCLI環境に合わせて簡略化 (自動承認を基本とするなど)

4. **コードベースのリファクタリング**: VS Code拡張機能固有部分とCLIアプリのコアロジックを明確に分離。
    - **コアロジックの独立**: コアロジック (`src/core`, `src/api` など) を `src/lib` ディレクトリ等に移動し、VS Code 依存を排除
    - **インターフェース定義**: インターフェースまたは抽象クラスを用いて、CLI固有コンポーネントとコアコンポーネントの境界を明確化
    - **依存性注入**: 依存性注入を積極的に活用し、コンポーネントのモジュール化、テスト容易性を向上

5. **CLIアプリケーションのビルド**: `tsconfig.json` と `package.json` を設定し、CLIアプリケーションをNode.js実行可能ファイルとしてビルド。
    - `tsconfig.json` で `outDir`, `rootDir` をCLIアプリ向けに設定
    - `package.json` に `bin` エントリを追加し、CLI実行可能ファイル (`build/cli.js` など) を指定
    - `package.json` の `build` スクリプトを更新し、CLIアプリをビルドパイプラインに追加

6. **CLIアプリケーションのテスト**: 作成されたCLIアプリケーションに対し、以下の項目を中心にテストを実施。
    - コマンドライン引数 (`yargs`, `commander`) の解析
    - CLIからのテキスト指示によるAIコーディング支援機能の動作検証
    - `execute_command` などのツールがCLI環境で正しく実行できるか
    - コード変更が差分形式でCLI出力されるか
    - スクリプトからの自動実行 (非対話的な動作)

この改訂版計画に基づき、CLIアプリケーションの実装に着手します。まずは、コアロジックの特定とVS Code依存性の分離を重点的に行い、段階的にCLIアプリケーションとしての機能を実装していく予定です。

</final_file_content>
</write_to_file>
